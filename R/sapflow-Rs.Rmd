---
title: "sapflow-Rs"
author: "SP"
date: "9/10/2019"
output: html_document
---

##Prelim plots to make:
* figure out how to calculate Js
* table with no of datapoints
* available time periods
* need table with Js, table with Rs, climate data
* then add all to one dataframe on common time frame
* TOD facet by month, Js/Rs lines

```{r functions, echo = FALSE, message = FALSE}
# Load functions
library(readr)
library(tidyr)
library(dplyr)
library(ggplot2)
library(lubridate)
library(viridis)

```

```{r load-data, echo = FALSE, message = FALSE}
# Load in Rs, K, weather, and inventory data
inventory <- read_csv("../../PREMIS-seawater/inventory/ss-inventory.csv")
ports_lt <- read_csv("../../PREMIS-ghg/design/LT_portcodes.csv")

read_csv("../SERC/baseliner_data/control_Kest_yr.csv", col_names = c("Year", "DOY","Time","VPD", "PAR", "C1", "C2", "C3", "C4", "C5", "C6", "C7", "C8")) %>% 
  mutate(Date = as_date(DOY - 1, origin = "2018-01-01")) %>% 
  separate(Date, c("Y", "Month", "Day"), sep = "-") %>% 
  separate(Time, c("Hour", "Min"), sep = -2) -> control_hm
  
control_hm$Hour[control_hm$Hour == ""] <- 0

control_hm %>% 
  mutate(Timestamp = mdy_hm(paste0(Month, "-", Day, "-", Year, " ", Hour, ":", Min))) %>%
  select(-Y, -Year, - Day, - Month) %>% 
  gather("Tree", "K", C1:C8) %>% 
  left_join(inventory, by = c("Tree" = "Sapflux")) %>% 
  select(Timestamp, VPD, PAR, K, Tree, Species_code, Plot) -> control_long

read_csv("../SERC/con_licor_data_20191120.csv") %>%
  left_join(ports_lt, by = "Port") -> rs_long

##need to load in weather data

```

```{r data-cleaning, echo = FALSE, message = FALSE}
# Next, we need to filter for the Js trees that also have Rs measurements
rs_trees <- unique(ports_lt$Tree)

control_long %>% 
  filter(Tree %in% rs_trees) %>% 
  # Then, we need to round the timestamp to the nearest hour and take hourly averages
  mutate(Timestamp = round_date(Timestamp, unit = "hour")) %>% 
  # Now that all data are on a common timeframe, we can take the hourly mean of each dataset
  group_by(Timestamp, Tree) %>% 
  summarise(K_avg = mean(K)) -> control_filter

control_filter %>% 
  mutate(Hour = hour(Timestamp)) %>% 
  group_by(Hour, Tree) %>% 
  summarise(K_havg = mean(K_avg, na.rm = TRUE)) -> control_havg

rs_long %>% 
  mutate(Timestamp = round_date(Timestamp, unit = "hour")) %>% 
  group_by(Timestamp, Tree) %>% 
  summarise(rs_avg = mean(Flux)) -> rs_filter

rs_filter %>% 
  mutate(Hour = hour(Timestamp)) %>% 
  group_by(Hour, Tree) %>% 
  summarise(rs_havg = mean(rs_avg, na.rm = TRUE)) -> rs_havg

left_join(rs_havg, control_havg) -> hourly

gather(hourly, key = "Type", value = "Value", rs_havg:K_havg) -> hourly_long

left_join(control_filter, rs_filter) -> combined
  
```

```{r hour-of-day}
ggplot(hourly_long, aes(x = Hour, Value)) +
  geom_point(aes(color = Type), size = 1) +
  scale_color_viridis(discrete = TRUE, 
                      option = "D", 
                      begin =0, 
                      end = 0.5,
                      labels = c("Js", "Rs")) +
  labs(title = "Value by hour of day", x = "Hour of Day", y = "Value") +
  facet_wrap(~Tree) + 
  theme_bw()
  
```

```{r rs-js}
ggplot(hourly, aes(x = K_havg, rs_havg)) +
  geom_point(aes(color = Hour)) +
  scale_color_viridis(discrete = FALSE) +
  labs(x = "Js", y = "Rs") +
  theme_bw()

```


Number of Js obs: `r sum(complete.cases(combined$K_avg))`

Number of Rs obs: `r sum(complete.cases(combined$rs_avg))`


