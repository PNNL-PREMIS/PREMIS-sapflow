---
title: "Sapflow Results"
author: "SP"
date: "September 18, 2019"
output: html_document
---

```{r setup, echo = FALSE, message=FALSE, warning = FALSE}
library(readr)
library(tidyr)
library(dplyr)
library(ggplot2)

inventory <- read_csv("../../PREMIS-stormsurge/inventory/ss-inventory.csv")

read_csv("../SERC/baseliner_data/shoreline_Kest.csv", col_names = c("Plot.ID", "DOY","Time","VPD", "PAR", "L1", "L2", "L3", "L4", "L5", "L6")) %>% 
  select(-VPD, -PAR, - Plot.ID) %>% 
  gather("Tree", "K", L1:L6) %>% 
  mutate(Species_code = "ACRU", Plot = "Shoreline") -> shoreline

read_csv("../SERC/baseliner_data/freshwater_Kest.csv", col_names = c("Plot.ID", "DOY","Time","VPD", "PAR", "F1", "F2", "F3", "F4", "F5", "F6", "F7", "F8")) %>% 
  select(-VPD, -PAR, - Plot.ID) %>% 
  gather("Tree", "K", F1:F8) %>% 
  left_join(inventory, by = c("Tree" = "Sapflux")) %>% 
  select(DOY, Time, Tree, K, Species_code, Plot) -> freshwater

read_csv("../SERC/baseliner_data/seawater_Kest.csv", col_names = c("Plot.ID", "DOY","Time","VPD", "PAR", "S1", "S2", "S3", "S4", "S5", "S6", "S7", "S8")) %>% 
  select(-VPD, -PAR, - Plot.ID) %>% 
  gather("Tree", "K", S1:S8) %>% 
  left_join(inventory, by = c("Tree" = "Sapflux")) %>% 
  select(DOY, Time, Tree, K, Species_code, Plot) -> seawater

read_csv("../SERC/baseliner_data/control_Kest.csv", col_names = c("Plot.ID", "DOY","Time","VPD", "PAR", "C1", "C2", "C3", "C4", "C5", "C6", "C7", "C8")) %>% 
  select(-VPD, -PAR, - Plot.ID) %>% 
  gather("Tree", "K", C1:C8) %>% 
  left_join(inventory, by = c("Tree" = "Sapflux")) %>% 
  select(DOY, Time, Tree, K, Species_code, Plot) -> control

sapflow <- rbind(seawater, freshwater, shoreline, control)

sapflow %>% mutate(Elevation = if_else(grepl("^L", Tree), "Shoreline", "Upland")) -> sapflow

```

```{r plot functions, echo = FALSE}

doy <- function(timeseries){
  timeseries %>%
  group_by(DOY, Tree) %>% 
  summarise(meanK = mean(K, na.rm = TRUE), n = n()) %>% 
  ggplot(aes(x = DOY, y = meanK)) + 
  geom_point(aes(color = Tree), alpha = 0.5) + 
  facet_wrap(~Tree) + 
  geom_smooth(color = "black") + 
  ylab("Kest") +
  xlab("Day of Year")
}

tod <- function(timeseries) {
  timeseries %>%
  group_by(Time, Tree) %>% 
  summarise(meanK = mean(K, na.rm = TRUE), n = n()) %>%
  ggplot(aes(x = Time, y = meanK)) + 
  geom_line(aes(color = Tree), size = 1.5) +
  ylab("Kest") + 
  xlab("Time of Day")
}

hist <- function(timeseries) {
  timeseries %>% 
  ggplot(aes(DOY)) +
  geom_histogram(binwidth = 30) +
  facet_wrap(~Tree)
}

```

## Summary plots

### ...by species and plot - time of day
```{r, echo = FALSE, massage = FALSE}

sapflow %>% 
  group_by(Elevation, Time, Species_code, Plot) %>% 
  summarise(meanK = mean(K, na.rm = TRUE), n = n()) %>% 
  ggplot(aes(x = Time, y = meanK, color = Species_code)) + 
  geom_line(size = 1) + 
  facet_grid(~Plot)

```

### ...by species and plot - day of year
```{r, echo = FALSE, message = FALSE}

sapflow %>% 
  group_by(Elevation, DOY, Species_code, Plot) %>% 
  summarise(meanK = mean(K, na.rm = TRUE), n = n()) %>% 
  ggplot(aes(x = DOY, y = meanK, color = Species_code)) + 
  geom_smooth() + 
  facet_grid(~Plot)

```

### ...Red Maple by elevation - time of day
```{r, echo = FALSE, message = FALSE}

sapflow %>% 
  filter(Species_code == "ACRU") %>%
  group_by(Elevation, Time, Species_code) %>% 
  summarise(meanK = mean(K, na.rm = TRUE), sdK = sd(K, na.rm = TRUE)) %>% 
  ggplot(aes(x = Time, y = meanK)) +
  geom_line(aes(color = Elevation), size = 1.5) +
# geom_errorbar(aes(ymin = meanK - sdK, ymax = meanK + sdK)) +
  ggtitle("Mean K for Maples at SERC") + 
  ylab("K")

```

### ...plot mean by time of day
```{r, echo = FALSE, message = FALSE, warning = FALSE}

sapflow %>% group_by(Time, Plot) %>% 
  summarise(meanK = mean(K, na.rm = TRUE), sdK = sd(K, na.rm = TRUE)) %>% 
  ggplot(aes(x = Time, y = meanK, color = Plot)) + 
  geom_line(size = 1.5)
# geom_errorbar(aes(ymin = meanK - sdK, ymax = meanK + sdK))

```

### ...plot mean by time of day
```{r, echo = FALSE, message = FALSE, warning = FALSE}

sapflow %>% group_by(DOY, Plot) %>% 
  summarise(meanK = mean(K, na.rm = TRUE), n = n()) %>% 
  ggplot(aes(x = DOY, y = meanK, color = Plot)) + 
  geom_smooth()

```